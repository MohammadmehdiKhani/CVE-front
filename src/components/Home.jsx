import React, { useState, useEffect } from "react";
import ProgramsTable from "./ProgramsTable";
import http from "../services/httpService.js";
import BarLoader from "react-spinners/BarLoader";
const { SERVER_BASE_URL } = require("../env");

function Home() {
  const [myPrograms, setMyPrograms] = useState([]);
  const [isAnyProgramDeleted, setIsAnyProgramDeleted] = useState(false);
  let [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchData() {
      try {
        const myProgramsResponse = await http.get(
          `${SERVER_BASE_URL}/my-cpes`,
          {
            headers: { "x-auth-token": localStorage.getItem("token") },
          }
        );
        setMyPrograms(myProgramsResponse.data);
        setLoading(false);
      } catch (e) {
        if (e.response && e.response.status == 401) {
          window.location = "/";
        }
      }
    }
    fetchData();
  }, [isAnyProgramDeleted]);

  const handleDeleteItem = async (item) => {
    await http.delete(`${SERVER_BASE_URL}/my-cpes/${item.cpeId}`, {
      headers: { "x-auth-token": localStorage.getItem("token") },
    });

    if (isAnyProgramDeleted === false) setIsAnyProgramDeleted(true);
    else setIsAnyProgramDeleted(false);
  };

  return (
    <div className="centeral-container ">
      <div className="page-top-title farsi-bold">برنامه‌ها</div>

      <BarLoader
        className="mt-3"
        color={"#a4b5ff"}
        loading={loading}
        size={100}
        aria-label="Loading Spinner"
        data-testid="loader"
      />

      {myPrograms.length > 0 && (
        <ProgramsTable
          handleDeleteItem={(i) => {
            handleDeleteItem(i);
          }}
          items={myPrograms}
        ></ProgramsTable>
      )}

      {myPrograms.length <= 0 && !loading && (
        <div className="farsi">
          هنوز برنامه‌ای به لیست برنامه‌هایتان اضافه نکرده‌اید.
        </div>
      )}
    </div>
  );
}

export default Home;
