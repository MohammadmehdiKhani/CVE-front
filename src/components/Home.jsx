import React, { useState, useEffect } from "react";
import SearchBox from "./SearchBox";
import "../style/home.css";
import ProgramTable from "./ProgramsTable";
import http from "../services/httpService.js";
import { flatMap } from "lodash";

function Home() {
  const [allPrograms, setAllPrograms] = useState([]);
  const [myPrograms, setMyPrograms] = useState([]);
  const [isProgramschanged, setIsProgramsChanged] = useState(false);

  useEffect(() => {
    async function fetchData() {
      const allProgramsResponse = await http.get(
        "http://localhost:3001/programs",
        {
          headers: { "x-auth-token": localStorage.getItem("token") },
        }
      );
      setAllPrograms(allProgramsResponse.data.programs);

      const myProgramsResponse = await http.get(
        "http://localhost:3001/my-programs",
        {
          headers: { "x-auth-token": localStorage.getItem("token") },
        }
      );
      setMyPrograms(myProgramsResponse.data.programs);
    }
    fetchData();
  }, [isProgramschanged]);

  const handleDeleteItem = async (item) => {
    await http.delete("http://localhost:3001/my-programs", {
      headers: { "x-auth-token": localStorage.getItem("token") },
      data: {
        id: item._id,
      },
    });

    if (isProgramschanged === false) setIsProgramsChanged(true);
    else setIsProgramsChanged(false);

    //const newPrograms = programs.filter((p) => p.id !== item.id);
    //setPrograms(newPrograms);
  };

  return (
    <div className="HomePage-container">
      <SearchBox
        options={allPrograms}
        reRenderProgramTable={() => {
          if (isProgramschanged === false) setIsProgramsChanged(true);
          else setIsProgramsChanged(false);
        }}
      ></SearchBox>

      <div className="mt-5 farsi-bold">جدول برنامه‌ها</div>
      <ProgramTable
        handleDeleteItem={(i) => {
          console.log("this shit works for " + i.name);
          handleDeleteItem(i);
        }}
        items={myPrograms}
      ></ProgramTable>
    </div>
  );
}

export default Home;
