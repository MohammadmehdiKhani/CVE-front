import React from "react";
import { useState, useEffect, useRef } from "react";
import http from "../services/httpService.js";
import "../style/searchBox.css";

function SearchBox({ options, reRenderProgramTable }) {
  const [value, setValue] = useState("");
  const [showSuggestions, setShowSuggestions] = useState(false);

  const SearchBoxRef = useRef(null);

  useEffect(() => {
    document.addEventListener("click", handleClickOutOfSearchBox);

    return () => {
      document.removeEventListener("click", handleClickOutOfSearchBox);
    };
  }, []);

  const soggestions = options.filter((o) =>
    o.name.toLowerCase().includes(value.toLowerCase())
  );

  const handleChange = (e) => {
    setValue(e.target.value);
  };

  const handleSuggestionsClick = async (s) => {
    setValue("");

    const response = await http.post(
      "http://localhost:3001/my-programs",
      { id: s._id },
      {
        headers: { "x-auth-token": localStorage.getItem("token") },
      }
    );
    reRenderProgramTable();
    setShowSuggestions(false);
  };

  const handleClickOutOfSearchBox = (e) => {
    if (!SearchBoxRef.current.contains(e.target)) {
      setShowSuggestions(false);
    }
  };

  return (
    <div>
      <div className="mb-2 farsi-bold">جستجوی برنامه جدید</div>

      <div className="SearchBox-container farsi" ref={SearchBoxRef}>
        <input
          value={value}
          placeholder="برنامه مورد نظرتان را اینجا پیدا کنید"
          onChange={handleChange}
          onFocus={() => setShowSuggestions(true)}
        ></input>
        {showSuggestions && (
          <ul className="suggestions">
            {soggestions.map((s) => (
              <li onClick={() => handleSuggestionsClick(s)} key={s._id}>
                {s.name}
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  );
}

export default SearchBox;
